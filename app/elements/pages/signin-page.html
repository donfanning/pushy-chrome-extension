<!--
  ~ Copyright (c) 2016-2017, Michael A. Updike All rights reserved.
  ~ Licensed under Apache 2.0
  ~ https://opensource.org/licenses/Apache-2.0
  ~ https://goo.gl/wFvBM1
  -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-localstorage/iron-localstorage.html">

<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">

<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">

<link rel="import" href="../my_icons.html">

<script type="text/javascript"
        src="../../bower_components/chrome-extension-utils/scripts/exception_handler.js"></script>

<dom-module id="signin-page">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style include="shared-styles"></style>
    <style>

      :host {
        display: block;
        position: relative;
      }

      #errorDialog {
        max-width: 40vw;
      }

      .contentContainer {
        min-height: 25vh;
      }

      #description {
        padding: 0;
        margin: 16px 16px 16px 16px
      }

      .buttonContainer {
        padding-top: 16px;
        padding-bottom: 8px;
        border-top: 1px solid #d9d9d9;
      }

      #googleAccountButton {
        outline: none;
        font-size: 14px;
        font-weight: 400;
        font-family: 'RobotoDraft', 'Roboto', arial, sans-serif;
        white-space: nowrap;
        cursor: pointer;
        background: #fff;
        border: 1px solid #d9d9d9;
        border-radius: 3px;
        box-sizing: border-box;
        margin: 0 0.29em;
        z-index: 0;
      }

      iron-icon {
        width: 22px;
        height: 22px;
        margin: 6px;
      }

      #waiter {
        margin: 20px auto;
      }

      #waiter paper-item {
        @apply(--paper-font-title);
      }

    </style>

    <paper-card class="page-content"
                heading="[[_computeTitle(signedIn)]]">
      <div class="card-content">

        <!-- Error dialog -->
        <paper-dialog id="errorDialog" modal
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
          <h2 id="dialogTitle" class="vertical layout center"></h2>
          <paper-dialog-scrollable>
            <paper-item id="dialogText"></paper-item>
          </paper-dialog-scrollable>
          <div class="buttons">
            <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
            <paper-button dialog-confirm hidden$="[[!confirmButton]]"
                          on-click="_onDialogButtonClicked">OK
            </paper-button>
          </div>
        </paper-dialog>

        <div class="contentContainer horizontal layout center">
          <paper-item id="description"
                      style$="display: [[_computeDescDisplay(waiting, signedIn)]];">
            You must be signed in to the Browser with the account you
            wish to use to share with your other devices. It is only used to ensure
            that all messages goes to a single account. You also need to "Allow Notifications"
            so the extension can send and receive messages.
          </paper-item>

          <div id="waiter" class="vertical layout center"
               style$="display: [[_computeWaiterDisplay(waiting)]];">
            <div class="horizontal center-justified layout">
              <paper-spinner active="[[waiting]]" tabindex="-1"></paper-spinner>
            </div>
            <paper-item>[[_computeWaiterLabel(waiting)]]</paper-item>
          </div>
        </div>
        <div class="buttonContainer vertical layout center">
          <paper-item id="googleAccountButton" tabindex="0"
                      on-click="_onAccountButtonClicked" disabled$="[[signInDisabled]]">
            <paper-ripple center></paper-ripple>
            <iron-icon icon="myicons:google" item-icon></iron-icon>
            <span class="setting-label">[[_computeButtonLabel(signedIn)]]</span>
          </paper-item>
        </div>
      </div>
    </paper-card>
    <iron-localstorage name="signedIn" value="{{signedIn}}"
                       on-iron-localstorage-load-empty="_initSignedIn"></iron-localstorage>
  </template>
</dom-module>

<script>
  (function(window) {
    'use strict';

    new ExceptionHandler();

    const ERROR_NETWORK = 'There is no Internet connection';
    const ERROR_SIGN_IN = 'Failed to sign in.';
    const ERROR_SIGN_OUT = 'Failed to sign out.';
    const ERROR_PERMISSION =
        'Notification permission is required to sign-in.';
    let ERROR_BLOCKED_MESSAGE =
        `<p>You either blocked notifications for the extension or the Chrome
          settings block all notifications.<br />
          If you want to sign-in, go to <b>Chrome settings</b> and click
          on <b>Advanced</b>.
          Click on <b>Content settings</b> then <b>Notifications</b>.
          Make sure <b>Ask before sending (recommended)</b> is selected.
          In the <b>Block</b> area allow <b>Pushy Clipboard</b>.
        </p>`;
    const ERROR_DEFAULT_MESSAGE =
        'Display notification pop-up again?';
    const ERROR_UNKNOWN_MESSAGE =
        'An error occurred. Please try again later.<br />';

    window.app = window.app || {};
    app.SignInPageFactory = Polymer({
      is: 'signin-page',

      properties: {
        signedIn: {
          type: Boolean,
          value: false,
          notify: true,
        },

        signInDisabled: {
          type: Boolean,
          value: true,
          notify: true,
        },

        waiting: {
          type: Boolean,
          value: false,
          notify: true,
        },

        confirmButton: {
          type: Boolean,
          value: false,
        },
      },

      onCurrentPage: function() {
        this._checkChromeSignIn();
      },

      /**
       * Determine if the user is signed into the Browser
       * @private
       */
      _checkChromeSignIn: function() {
        const chromep = new ChromePromise();
        chromep.identity.getProfileUserInfo().then((userInfo) => {
          if (!app.Utils.isSignedIn() &&
              Chrome.Utils.isWhiteSpace(userInfo.id)) {
            this.set('signInDisabled', true);
          } else {
            this.set('signInDisabled', false);
            this._checkPermissions();
          }
          return Promise.resolve();
        }).catch((err) => {
          Chrome.Log.error(err.message, 'SignInPage._checkChromeSignIn');
        });
      },

      /**
       * Display popup to Allow Notifications if necessary
       * @private
       */
      _checkPermissions: function() {
        // Note: Don't rely on Notification.permission
        // if extension requests notifications permission
        this.set('signInDisabled', true);
        Notification.requestPermission().then((permission) => {
          if (permission === 'denied') {
            // user denied or Chrome setting blocks all
            if (app.Utils.isSignedIn()) {
              // force sign out
              this._forceSignOut();
            }
            this._showDialog(ERROR_PERMISSION, ERROR_BLOCKED_MESSAGE,
                false);
          } else if (permission === 'default') {
            // user closed notification popup
            if (app.Utils.isSignedIn()) {
              // force sign out
              this._forceSignOut();
            }
            this._showDialog(ERROR_PERMISSION, ERROR_DEFAULT_MESSAGE,
                true);
          } else {
            // granted
            this.set('signInDisabled', false);
          }
          return Promise.resolve();
        }).catch((err) => {
          // something went wrong
          Chrome.Log.error(err.message, 'SignInPage._checkPermissions');
          this._showDialog(ERROR_PERMISSION,
              ERROR_UNKNOWN_MESSAGE + err.message, false);
        });
      },

      /**
       * Attempt to sign in with current Browser account
       * @private
       */
      _signIn: function() {
        Chrome.Msg.send(app.ChromeMsg.SIGN_IN).then((response) => {
          if (response.message === 'error') {
            Chrome.Log.error(response.error, 'SignInPage._signIn');
            this._showDialog(ERROR_SIGN_IN, response.error, false);
          }
          this.set('waiting', false);
          return Promise.resolve();
        }).catch(() => {
          this.set('waiting', false);
        });
      },

      /**
       * Attempt to sign out of current Browser account
       * @private
       */
      _signOut: function() {
        Chrome.Msg.send(app.ChromeMsg.SIGN_OUT).then((response) => {
          if (response.message === 'error') {
            // just force it to happen
            this._forceSignOut();
          }
          this.set('waiting', false);
          return Promise.resolve();
        }).catch(() => {
          this.set('waiting', false);
        });
      },

      /**
       * Force sign out
       * @private
       */
      _forceSignOut: function() {
        Chrome.Msg.send(app.ChromeMsg.FORCE_SIGN_OUT).catch(() => {});
      },

      _showDialog: function(title, text, confirmButton) {
        text = text.replace('\n', '<br/>');
        this.$.dialogTitle.innerHTML = title;
        this.$.dialogText.innerHTML = text;
        this.set('confirmButton', confirmButton);
        this.$.errorDialog.open();
      },

      _onAccountButtonClicked: function() {
        Chrome.GA.event(Chrome.GA.EVENT.BUTTON,
            `SignInPage.accountButton: ${!this.signedIn}`);
        if (!navigator.onLine) {
          const title = this.signedIn ? ERROR_SIGN_OUT : ERROR_SIGN_IN;
          Chrome.Log.error(ERROR_NETWORK, 'SignInPage._accountButton', title);
          this._showDialog(title, ERROR_NETWORK, false);
        } else {
          this.set('waiting', true);
          this.signedIn ? this._signOut() : this._signIn();
        }
      },

      _onDialogButtonClicked: function() {
        this._checkPermissions();
      },

      _computeTitle: function(isSignedIn) {
        const signedIn = `Signed in as: ${Chrome.Storage.get('email')}`;
        const signedOut = 'Account Sign In';
        return isSignedIn ? signedIn : signedOut;
      },

      _computeButtonLabel: function(signedIn) {
        return signedIn ? 'Sign out' : 'Sign in';
      },

      _computeWaiterLabel: function() {
        return this.signedIn ? 'Signing Out...' : 'Signing In...';
      },

      _computeDescDisplay: function(waiting, signedIn) {
        return (waiting || signedIn) ? 'none' : 'block';
      },

      _computeWaiterDisplay: function(waiting) {
        return waiting ? 'block' : 'none';
      },

      /**
       * initialize value if it is not in localStorage
       */
      _initSignedIn: function() {
        this.set('signedIn', false);
      },
    });
  })(window);
</script>
