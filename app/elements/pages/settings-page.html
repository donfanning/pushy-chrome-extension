<!--
  ~ Copyright (c) 2016-2017, Michael A. Updike All rights reserved.
  ~ Licensed under Apache 2.0
  ~ https://opensource.org/licenses/Apache-2.0
  ~ https://goo.gl/wFvBM1
  -->
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">

<link rel="import" href="../../bower_components/setting-elements/setting-toggle/setting-toggle.html">
<link rel="import" href="../../bower_components/setting-elements/setting-dropdown/setting-dropdown.html">
<link rel="import" href="../../bower_components/setting-elements/setting-text/setting-text.html">

<dom-module id="settings-page">
  <style include="iron-flex iron-flex-alignment"></style>
  <style include="shared-styles"></style>
  <template>
    <style>

      :host {
        display: block;
        position: relative;
      }

    </style>

    <paper-card class="page-content" heading="Settings">
      <div class="card-content">

        <!-- Error dialog -->
        <paper-dialog id="errorDialog" modal
                      entry-animation="scale-up-animation"
                      exit-animation="fade-out-animation">
          <h2 id="dialogTitle" class="vertical layout center"></h2>
          <paper-dialog-scrollable>
            <paper-item id="dialogText"></paper-item>
          </paper-dialog-scrollable>
          <div class="buttons">
            <paper-button dialog-dismiss autofocus>CLOSE</paper-button>
          </div>
        </paper-dialog>

        <setting-toggle
            section-title="Clipboard & messaging"
            name="monitorClipboard"
            main-label="Monitor clipboard"
            secondary-label="Automatically store contents when possible">
        </setting-toggle>
        <setting-toggle
            name="allowPush"
            main-label="Push to devices"
            secondary-label="Send messages to your registered devices"
            checked="{{pushEnabled}}">
        </setting-toggle>
        <setting-toggle
            name="autoSend"
            main-label="Auto send"
            secondary-label="Automatically send when possible"
            disabled$="[[!pushEnabled]]"
            indent>
        </setting-toggle>
        <setting-toggle
            name="allowReceive"
            main-label="Receive from devices"
            secondary-label="Receive messages from your registered devices">
        </setting-toggle>
        <setting-toggle
            name="highPriority"
            main-label="High priority message"
            secondary-label="Wakes android devices for immediate delivery. Uses more battery."
            noseparator>
        </setting-toggle>

        <setting-text
            section-title="General"
            id="deviceNickname"
            name="deviceNickname"
            main-label="Nickname"
            secondary-label="Descriptive name for this device"
            placeholder="e.g. Home Laptop"
            maxlength="32">
        </setting-text>
        <setting-dropdown
            name="storageDuration"
            label="Storage duration"
            items='["One day", "One week", "One month",
						 "One year", "Until space needed"]'
            noseparator>
        </setting-dropdown>

        <setting-toggle
            section-title="Notifications"
            name="notifyOnCopy"
            main-label="Notify on clipboard change"
            secondary-label="Display notification when a copy/cut is detected">
        </setting-toggle>
        <setting-toggle
            name="notifyOnSend"
            main-label="Notify on send"
            secondary-label="Display notification when a message is sent">
        </setting-toggle>
        <setting-toggle
            name="notifyOnError"
            main-label="Notify on error (recommended)"
            secondary-label="Display notification when an error occurs"
            noseparator>
        </setting-toggle>
      </div>
    </paper-card>
  </template>
</dom-module>

<script>
  (function(window) {
    'use strict';

    new ExceptionHandler();

    const ERROR_TITLE = 'Failed to change setting';

    window.app = window.app || {};

    /**
     * Polymer element to manage extension settings
     * @namespace SettingsPage
     */
    app.SettingsPageFactory = Polymer({
      is: 'settings-page',

      /**
       * Element is ready
       * @memberOf SettingsPage
       */
      ready: function() {
        // listen for chrome messages
        Chrome.Msg.listen(this._onChromeMessage.bind(this));
      },

      // noinspection JSUnusedLocalSymbols
      /**
       * Event: Fired when a message is sent from either an extension process<br>
       * (by runtime.sendMessage) or a content script (by tabs.sendMessage).
       * @see https://developer.chrome.com/extensions/runtime#event-onMessage
       * @param {Chrome.Msg.Message} request - details for the
       * @param {string} request.error - error message
       * @param {Object} sender - MessageSender object
       * @param {function} response - function to call once after processing
       * @returns {boolean} true if asynchronous
       * @private
       * @memberOf SettingsPage
       */
      _onChromeMessage: function(request, sender, response) {
        let ret = false;
        if (request.message === app.ChromeMsg.REGISTER_FAILED.message) {
          this._showDialog(ERROR_TITLE, request.error);
        } else if (request.message === app.ChromeMsg.UNREGISTER_FAILED.message) {
          this._showDialog(ERROR_TITLE, request.error);
        }
        return ret;
      },

      /**
       * Display error dialog
       * @param {string} title - error title
       * @param {string} text - description of error
       * @private
       * @memberOf SettingsPage
       */
      _showDialog: function(title, text) {
        text = text.replace('\n', '<br/>');
        this.$.dialogTitle.innerHTML = title;
        this.$.dialogText.innerHTML = text;
        this.$.errorDialog.open();
      },
    });
  })(window);
</script>
